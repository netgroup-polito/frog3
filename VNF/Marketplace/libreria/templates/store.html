<!doctype html>
<html lang="en">
	<head>
	  <meta charset="utf-8">
	  <title>{{ title }}</title>
	  {% load staticfiles %}
	  <link rel="stylesheet" href={% static "jquery-ui.css" %}>
	  <link rel="stylesheet" href={% static "jquery-ui.theme.css" %}>
	  <link rel="stylesheet" href={% static "bootstrap.css" %}>
	  <link rel="stylesheet" href={% static "bootstrap-theme.css" %}>
	  <link rel="stylesheet" href={% static "style.css" %}>
	  <script type="text/javascript" src={% static "jquery.js" %}></script>
	  <script type="text/javascript" src={% static "jquery-ui.js" %}></script>
	  <script type="text/javascript" src={% static "jquery.cookie.js" %}></script>
	  
	  <script type="text/javascript">
	  $(function() {
	  	var saved = true;
	  	
	  	$( "ul.sourceList" ).sortable({
	    	connectWith: "ul",
	    });
	 
	    $( "ul.targetList" ).sortable({
	    	connectWith: "ul",
	    	cancel: ".empty-placeholder",
	    	receive: function( event, ui ) {
	    		console.log(event);
	    		console.log(ui.item);
	    		numItems = $(".targetList").find('li').length;
	    		if(numItems==2){
					$(".targetList").find('li.empty-placeholder').hide();
				}
				saved = false;
	    	},
	    	remove: function( event, ui ) {
	    		numItems = $(".targetList").find('li').length;
	    		if(numItems==1){
					$(".targetList").find('li.empty-placeholder').show();
				}
				saved = false;
	    	}
	    });
	 
	    $( "#sortable1, #sortable2" ).disableSelection();
	    
	    $("a#logout").bind("click",function (event) {

			if($(".targetList").find('li').length > 1 && saved == false) {
				$('#startLoader').hide();
				var response = confirm("All changes will be lost, do you want to proceed anyway?");
				if(response == false) {
					return false;
				}
			}
			
			return true;
		});
		
		$(".navbar-btn").bind("click",function (event) {
			$('#startLoader').show();
		});
		
		$("#submit_button").bind("click",function (event) {
			var ser = $( "#sortable2" ).sortable("serialize", {expression: /(.+?)_(.+)/});
			var csrftoken = $.cookie("csrftoken");
			
			$('#startLoader').show();
			
			$.ajax({
				type: "POST",
				url: "/store/",
				data: {psa_ser: ser, csrfmiddlewaretoken: csrftoken},
				success: function(data) {
					$('#startLoader').hide();
					$("#response_message").removeClass("messageSuccess messageError");
					$('#response_message').show();
					$("#response_message").html("Customization saved");
					$("#response_message").addClass("messageSuccess");
					saved = true;
					setTimeout(function() { $('#response_message').hide(800); }, 5000 );
				},
				error: function(data) {
					console.log(data);
					$('#startLoader').hide();
					$("#response_message").removeClass("messageSuccess messageError");
					$('#response_message').show();
					$("#response_message").html("Error saving customizations");
					$("#response_message").addClass("messageError");
					setTimeout(function() { $('#response_message').hide(800); }, 5000 );
				},
			});
		});
		
		{% if response_message != '' %}
			{% if response_message == 'fail' %}
			$("#response_message").html("Upload error");
			$("#response_message").addClass("messageError");
			{% elif response_message == 'success' %}
			$("#response_message").html("Application uploaded successfully");
			$("#response_message").addClass("messageSuccess");
			{% endif %}
		setTimeout(function() { $('#response_message').hide(800); }, 5000 );
		{% endif %}
		
	});
	
	$(window).load(function() {
	    $('#startLoader').hide();
	});
	</script>
	
	</head>
	
	<body>
		
		<div id="startLoader"></div>
		
		<!-- Start Header -->
		<header class="header">
			<div class="title">MyStore - Customize your network services</div>
			<div class="nav">
				<nav>
					<ul class="nav nav-pills pull-right">
						
						<li role="presentation"><a href="/store/"><button type="button" class="btn btn-default navbar-btn">myStore</button></a></li>
						<li role="presentation"><a href="/app/"><button type="button" class="btn btn-default navbar-btn">myApps</button></a></li>
						<li role="presentation"><a id="logout" href="/logout/"><button type="button" class="btn btn-primary navbar-btn">Logout</button></a></li>
					</ul>
				</nav>
			</div>
		</header>
		<!-- End Header -->
		
		<!-- Start Section -->
		<section class="section" class="list-group">
			<div id="response_message"></div>
			<div id="list-available" class="list">
				<div class="description">MyStore Applications</div>
				<ul id="sortable1" class="sourceList">
				{% for image in all_app %}
					<li id="psa-id_{{ image.psa_id }}" class="ui-state-default">
						<span>{{ image.psa_name }}</span>
						<span class="price">Cost: {{ image.price }} â‚¬</span>
					</li>
				{% endfor %}
				</ul>
			</div>
			
			<div id="list-your" class="list">
				<div class="description">MyApps</div>
				
				<ul id="sortable2" class="targetList">
				 	{% for image in user_app %}
					<li id="psa-id_{{ image.psa_id }}" class="ui-state-default">
						<span>{{ image.psa_name }}</span>
					</li>
					{% empty %}
					<li class="empty-placeholder" style="display: list-item;">Drop here the services</li>
					{% endfor %}
				</ul>
				
			</div>
			
			<div id="upload_img">
				<button type="button" class="btn btn-primary save_btn">Add your own app</button>
			</div>
			
			<button type="button" id="submit_button" class="btn btn-primary save_btn">Apply Changes</button>			
		</section>
		<!-- End Section -->
		
		<!-- Start Footer -->
		<footer class="footer">
			<p>PSA</p>
		</footer>
		<!-- End Footer -->
		
	</body>
	
</html>